# BloomWatch Kenya - Unified Deployment Guide

## üéØ Single URL Architecture

Your application is now configured for **unified deployment** with a single web URL that provides all functionality.

## üì¶ Deployment Structure

### **2 Services Total:**

1. **bloomwatch-app** (Main Web Application)
   - **URL:** `https://bloomwatch-app.onrender.com`
   - **Technology:** Streamlit (multipage app)
   - **Pages:**
     - üè† **Home** - Farmer Portal (Main Dashboard)
       - Bloom detection & monitoring
       - Farmer registration
       - SMS alerts configuration
       - Real-time bloom maps
     - üîß **Admin** - Admin Dashboard
       - Farmer management
       - Send bulk SMS alerts
       - View message queues
       - Analytics & statistics

2. **bloomwatch-api** (Backend API)
   - **URL:** `https://bloomwatch-api.onrender.com`
   - **Technology:** Flask + Gunicorn
   - **Purpose:** USSD callback endpoint for Africa's Talking
   - **Endpoints:**
     - `POST /ussd` - USSD callback
     - `GET /health` - Health check

## üöÄ How to Deploy

### Step 1: Commit & Push Changes

```bash
cd /home/yogo/bloom-detector

# Add all changes
git add .

# Commit
git commit -m "Unified deployment: single web app with multipage structure"

# Push to GitHub
git push origin main
```

### Step 2: Deploy on Render via Blueprint

1. **Go to Render Dashboard:** https://dashboard.render.com/

2. **Navigate to Blueprints:**
   - Click "Blueprints" in the sidebar
   - Click "New Blueprint Instance"

3. **Connect Repository:**
   - Select your repository: `geoffreyyogo/bloom-detector`
   - Authorize if needed

4. **Configure Services:**
   Render will detect `render.yaml` and show **2 services**:
   
   ‚úÖ **bloomwatch-app** (Main Web App)
   ‚úÖ **bloomwatch-api** (USSD API Backend)

5. **Set Environment Variables:**
   
   For **BOTH services**, add:
   ```
   MONGODB_URI=mongodb+srv://...  (Your MongoDB Atlas connection string)
   AFRICASTALKING_USERNAME=your_username
   AFRICASTALKING_API_KEY=your_api_key
   ```
   
   For **bloomwatch-app** only, also add:
   ```
   ADMIN_PASSWORD=your_secure_admin_password
   ```

6. **Deploy:**
   - Click "Apply" to create both services
   - Wait for build to complete (~5-10 minutes)

### Step 3: Access Your Application

#### Main Application (Single URL):
```
https://bloomwatch-app.onrender.com
```

This URL provides:
- **Farmer Portal** (home page) - for farmers to register and view bloom data
- **Admin Dashboard** (accessible via sidebar navigation or `/üîß_Admin` page)

#### API Backend:
```
https://bloomwatch-api.onrender.com/ussd
```
- Use this URL as the callback URL in your Africa's Talking USSD channel configuration

## üì± Navigation

### For Farmers:
1. Visit `https://bloomwatch-app.onrender.com`
2. Access the main dashboard (home page)
3. Register or login
4. View bloom detection and maps

### For Administrators:
1. Visit `https://bloomwatch-app.onrender.com`
2. Click **"üîß Admin"** in the sidebar (or navigate to `/üîß_Admin`)
3. Login with admin credentials:
   - Username: `admin`
   - Password: (from your `ADMIN_PASSWORD` env var)
4. Manage farmers, send alerts, view analytics

## üîß Configuration

### Environment Variables Required:

| Variable | Required For | Description |
|----------|-------------|-------------|
| `MONGODB_URI` | Both services | MongoDB Atlas connection string |
| `AFRICASTALKING_USERNAME` | Both services | Africa's Talking username |
| `AFRICASTALKING_API_KEY` | Both services | Africa's Talking API key |
| `ADMIN_PASSWORD` | Web app only | Admin dashboard password |
| `SECRET_KEY` | Web app only | Auto-generated by Render |
| `FLASK_ENV` | API only | Set to `production` (default) |

### Africa's Talking Setup:

1. **USSD Channel:**
   - Callback URL: `https://bloomwatch-api.onrender.com/ussd`
   - Method: POST

2. **SMS Service:**
   - Already configured via API credentials
   - No additional webhook needed

## ‚ö†Ô∏è Important Notes

### Free Tier Limitations:
- Services spin down after 15 minutes of inactivity
- First request after spin-down takes ~30-60 seconds
- 750 hours/month free per service

### Performance Tips:
1. Keep the main app active by setting up an uptime monitor (e.g., UptimeRobot)
2. Warn users about initial load time
3. Consider upgrading to paid tier for production use

### Security:
- Change the default admin password immediately
- Use strong passwords for `ADMIN_PASSWORD`
- Never commit credentials to Git
- Use environment variables for all sensitive data

## üìä Monitoring

### Check Service Health:
- Main App: `https://bloomwatch-app.onrender.com` should show the farmer portal
- API: `https://bloomwatch-api.onrender.com/health` should return `{"status": "ok"}`

### View Logs:
- In Render Dashboard, click on each service
- View "Logs" tab to see real-time application logs
- Check for errors during startup or runtime

## üîÑ Updating Your Application

To deploy updates:

1. Make changes locally
2. Commit and push to GitHub:
   ```bash
   git add .
   git commit -m "Description of changes"
   git push origin main
   ```
3. Render will automatically rebuild and deploy both services

## üÜò Troubleshooting

### "Module not found" errors:
- Verify all dependencies are in `requirements.txt`
- Check build logs in Render Dashboard

### "Service unavailable":
- Service may be spinning up (wait 30-60 seconds)
- Check logs for startup errors

### USSD not working:
- Verify callback URL in Africa's Talking dashboard
- Check that API service is running
- Review API logs for incoming requests

### Admin page not accessible:
- Ensure you're using the correct credentials
- Check that `ADMIN_PASSWORD` is set in environment variables
- Clear browser cache and try again

## üìû Support

For issues or questions:
- Check Render logs first
- Review environment variables
- Verify MongoDB Atlas connection
- Test Africa's Talking credentials

## ‚úÖ Deployment Checklist

- [ ] Files committed and pushed to GitHub
- [ ] Blueprint deployed on Render
- [ ] Both services (app + api) running
- [ ] Environment variables configured
- [ ] Main app accessible at Render URL
- [ ] Admin dashboard accessible via sidebar
- [ ] Africa's Talking USSD callback URL updated
- [ ] Test farmer registration
- [ ] Test admin login
- [ ] Test SMS sending

---

**Your BloomWatch Kenya platform is now unified and ready for deployment! üåæüöÄ**

